<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Chart.js for graphs (will be fully utilized in phase 2) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #6200ea;
      --secondary: #03dac5;
      --light: #ffffff;
      --dark: #121212;
      --card-bg: #1f1f1f;
      --text-color: #ffffff;
      --ad-bg: #222;
      --ad-item-bg: #333;
      --border-color: #444;
      --danger: #dc3545;
      --success: #28a745;
      --info: #17a2b8;
      --h3-color: var(--text-color);
      --button-active-bg: var(--secondary);
      --button-active-color: #000;
    }

    body.light-mode {
      --dark: #ffffff;
      --card-bg: #ffffff;
      --text-color: #000000;
      --ad-bg: #f9f9f9;
      --ad-item-bg: #f1f1f1;
      --border-color: #dddddd;
      background: #ffffff !important;
      --button-active-bg: var(--primary);
      --button-active-color: #fff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--dark), #1a1a2e);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.4s ease;
      padding: 20px;
      text-align: center;
    }

    .container {
      width: 100%;
      max-width: 800px;
      background: var(--card-bg);
      border-radius: 20px;
      overflow: hidden;
      padding: 30px;
      transition: all 0.4s ease;
      position: relative;
    }

    h1 {
      font-size: 36px;
      color: var(--primary);
      margin-bottom: 30px;
      text-align: center;
    }

    .card {
      background: var(--ad-item-bg);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      border: 1px solid var(--border-color);
      text-align: left;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .card h2 {
      color: var(--secondary);
      margin-bottom: 15px;
      font-size: 26px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
    }
    
    .card h3 {
        color: var(--h3-color);
        margin-bottom: 10px;
        font-size: 20px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
      gap: 10px; 
      margin-bottom: 20px;
    }

    .stat-item {
      background: var(--card-bg);
      padding: 10px; 
      border-radius: 10px;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 13px; 
      min-height: 70px; 
      text-align: center; 
      word-break: break-word; 
    }

    .stat-item span {
      font-size: 26px; 
      font-weight: bold;
      color: var(--secondary);
      margin-top: 5px;
    }

    .input-with-button {
        display: flex;
        align-items: center;
        width: 100%;
        margin-top: 5px; /* Reduced margin-top */
        margin-bottom: 5px; /* Reduced margin-bottom */
    }

    .card input[type="text"], .card input[type="number"], .card input[type="password"], .card select {
      flex-grow: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 16px;
      margin-right: 0px; 
    }

    .card input[type="text"]:last-child {
        margin-right: 0; 
    }

    .btn {
      background: var(--secondary);
      color: #000;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 0px; 
      transition: background 0.2s ease, transform 0.2s ease;
      font-size: 16px;
      margin-top: 10px;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .btn.active {
        background: var(--button-active-bg);
        color: var(--button-active-color);
        box-shadow: 0 0 0 3px var(--secondary);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    #login-container {
      text-align: center;
      padding: 50px 20px;
    }

    #login-container input {
        display: block;
        margin: 10px auto;
        width: 80%;
        max-width: 300px;
        padding: 14px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-color);
        font-size: 17px;
    }

    #login-button {
      background: var(--primary);
      color: #fff;
      padding: 14px 30px;
      border-radius: 10px;
      font-size: 19px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: background 0.2s ease;
      margin-top: 20px;
    }

    #login-button:hover {
      filter: brightness(1.2);
    }

    /* Initially hide everything except loading, or login based on JS */
    #admin-content, #login-container {
      display: none;
    }
    
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex; /* Changed to flex to show initially */
        justify-content: center;
        align-items: center;
        z-index: 1001;
        color: var(--light);
        font-size: 24px;
        flex-direction: column;
    }

    .spinner {
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-top: 8px solid var(--primary);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }


    #mode-toggle {
      position: absolute;
      top: 15px;
      right: 30px; 
      padding: 5px; 
      background: transparent; 
      color: var(--primary); 
      border: none; 
      border-radius: 100px;
      cursor: pointer;
      font-size: 18px; 
      transition: all 0.3s ease;
      z-index: 1100;
      /* Initially hidden, will be shown by JS when admin content is visible */
      display: none; 
    }
    #mode-toggle:hover {
      background-color: rgba(98, 0, 234, 0.1); 
    }

    .ad-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: var(--light);
      padding: 20px 40px;
      border-radius: 12px;
      z-index: 1000;
      display: none;
      font-size: 18px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }

    /* --- CHART CONTAINER STYLES (for phase 2) --- */
    .chart-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin-top: 15px;
    }
    .chart-container canvas {
      max-width: 100%;
      height: 100% !important;
      width: 100% !important;
    }

    /* --- Responsive Adjustments --- */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .container {
        padding: 20px;
        border-radius: 15px;
      }

      h1 {
        font-size: 30px;
        margin-bottom: 25px;
      }

      .card {
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .card h2 {
        font-size: 22px;
        margin-bottom: 12px;
        padding-bottom: 8px;
      }
      
      .card h3 {
        font-size: 18px;
      }

      .stat-grid {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
        gap: 5px; 
      }
      
      .stat-item {
        padding: 8px; 
        font-size: 11px; 
        min-height: 60px; 
      }

      .stat-item span {
        font-size: 22px; 
      }

      .card input[type="text"], .card input[type="number"], .card input[type="password"], .card select {
        width: 100%;
        padding: 10px;
        font-size: 15px;
        margin-right: 0;
      }

      .input-with-button {
        flex-direction: column;
        align-items: stretch;
      }

      .input-with-button input {
        margin-right: 0;
        margin-bottom: 0px; /* Reduced margin-bottom */
      }

      .btn {
        width: 100%;
        margin-right: 0;
        margin-top: 10px; /* Adjusted for consistency */
        padding: 10px 15px;
        font-size: 15px;
      }
      
      .btn-primary + .btn {
        margin-top: 10px;
      }

      #login-container input {
        width: 90%;
        max-width: none;
        padding: 12px;
        font-size: 16px;
      }

      #login-button {
        padding: 12px 25px;
        font-size: 17px;
      }

      #mode-toggle {
        right: 20px; 
        font-size: 16px; 
        padding: 3px;
      }

      .chart-container {
        height: 200px; 
      }

      .ad-notification {
        width: 90%;
        padding: 15px 25px;
        font-size: 16px;
      }
    }
  </style>

</head>
<body>
  <div class="ad-notification" id="ad-notification"></div>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <p>Loading Admin Panel...</p>
  </div>
  <div class="container">
    <button id="mode-toggle" onclick="toggleMode()">ðŸŒ™</button>

    <div id="login-container">
      <h1>Admin Login</h1>
      <input type="text" id="admin-email" placeholder="Admin Email" autocomplete="username">
      <input type="password" id="admin-password" placeholder="Password" autocomplete="current-password">
      <button id="login-button" onclick="loginAdminWithEmailPassword()">Login</button>
    </div>

    <div id="admin-content">
      <h1>Admin Panel</h1>

      <div class="card">
        <h2>Visitor Overview</h2>
        <div class="stat-grid">
          <div class="stat-item">
            Total Views
            <span id="total-visitors">0</span>
          </div>
          <div class="stat-item">
            Today's Views (UTC)
            <span id="daily-visitors">0</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Ad Configuration</h2>
        <p>Active Ad Pattern: <span id="current-ad-pattern" style="color: var(--secondary); font-weight: bold;">Loading...</span></p>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; margin-bottom: 15px;">
            <button class="btn btn-primary" id="btn-monetag-only" onclick="updateAdPattern('monetagOnly')">Monetag Only</button>
            <button class="btn btn-primary" id="btn-mixed-ads" onclick="updateAdPattern('mixed')">Mixed Ads</button>
            <button class="btn btn-primary" id="btn-gigapub-only" onclick="updateAdPattern('gigapubOnly')">Gigapub Only</button>
        </div>

        <p style="margin-top: 20px;">Current Unlock Steps: <span id="current-total-steps" style="color: var(--secondary); font-weight: bold;">0</span></p>
        <label for="new-total-steps" style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold;">Set Unlock Steps:</label>
        <div class="input-with-button">
            <input type="number" id="new-total-steps" min="1" max="10" placeholder="e.g., 5" value="">
        </div>
        <button class="btn btn-primary" onclick="updateTotalSteps()">Update Steps</button>
      </div>


      <div class="card">
        <h2>Canva Pro Link</h2>
        <p>Canva Pro Link: <span id="current-canva-link" style="color: var(--secondary); word-break: break-all;">Loading...</span></p>
        <label for="new-canva-link" style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold;">Enter New Link:</label>
        <div class="input-with-button">
            <input type="text" id="new-canva-link" placeholder="https://www.canva.com/brand/join?token=..." value="">
        </div>
        <button class="btn btn-primary" onclick="updateCanvaLink()">Update Link</button>
      </div>

      <!-- These sections will be populated in Phase 2 -->
      <div class="card" style="display: none;" id="monthly-daily-card">
        <h2>Monthly Daily Visitor</h2>
        <div class="chart-container">
            <canvas id="daily-monthly-visitors-chart"></canvas>
        </div>
      </div>

      <div class="card" style="display: none;" id="visitor-details-card">
        <h2>Visitor Details</h2>
        <div class="monthly-daily-flex">
            <div style="flex: 1;">
                <h3>Select Month:</h3>
                <div id="monthly-stats-list">
                    <p>Loading monthly data...</p>
                </div>
            </div>
            <div style="flex: 1;">
                <h3>Daily Views for <span id="selected-month-display"></span>:</h3>
                <div id="daily-stats-list">
                    <p>Select a month to see daily views.</p>
                </div>
            </div>
        </div>
      </div>


      <button class="btn btn-danger" onclick="logoutAdmin()" style="margin-top: 20px;">Logout</button>

    </div>

  </div>
  <script>
    // Your Firebase Configuration (keep this the same)
    const firebaseConfig = {
      apiKey: "AIzaSyAGxSne9zxCPJNpVmfD6iQF7ajPJVq9dSE",
      authDomain: "canva-pro-team.firebaseapp.com",
      databaseURL: "https://canva-pro-team-default-rtdb.firebaseio.com",
      projectId: "canva-pro-team",
      storageBucket: "canva-pro-team.firebasestorage.app",
      messagingSenderId: "462948035203",
      appId: "1:462948035203:web:db7838356c4b1a23bc09b6"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    const ADMIN_UID = "NvDwBNvnCgg5QWyNMFQ8BevtusL2"; // Your Admin UID
    let dailyMonthlyVisitorsChart; // For Chart.js, will be used in Phase 2
    let currentSelectedMonth = ''; // For Chart.js, will be used in Phase 2

    let isInitialAuthCheckComplete = false;

    // Helper functions for UTC time (keep these the same)
    function getTodayKeyUTC() {
        const now = new Date();
        const year = now.getUTCFullYear();
        const month = (now.getUTCMonth() + 1).toString().padStart(2, '0');
        const day = now.getUTCDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function getFormattedDateUTC(year, month, day) {
        const date = new Date(Date.UTC(year, month - 1, day));
        const options = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
        return date.toLocaleDateString('en-US', options);
    }

    function getFormattedMonthUTC(year, month) {
        const date = new Date(Date.UTC(year, month - 1, 1));
        const options = { year: 'numeric', month: 'long', timeZone: 'UTC' };
        return date.toLocaleDateString('en-US', options);
    }

    window.addEventListener("DOMContentLoaded", () => {
        const savedMode = localStorage.getItem("themeMode");
        if (savedMode === "light") {
            document.body.classList.add("light-mode");
            document.getElementById("mode-toggle").textContent = "â˜€ï¸";
        }

        showLoadingOverlay();

        auth.onAuthStateChanged((user) => {
            if (!isInitialAuthCheckComplete) {
                if (user && user.uid === ADMIN_UID) {
                    setTimeout(() => {
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('admin-content').style.display = 'block';
                        document.getElementById('mode-toggle').style.display = 'block';
                        hideLoadingOverlay();
                        loadAdminData();
                    }, 1500);
                } else {
                    setTimeout(() => {
                        document.getElementById('login-container').style.display = 'block';
                        document.getElementById('admin-content').style.display = 'none';
                        document.getElementById('mode-toggle').style.display = 'none';
                        hideLoadingOverlay();
                    }, 1000);
                }
                isInitialAuthCheckComplete = true;
            } else {
                if (user && user.uid === ADMIN_UID) {
                    setTimeout(() => {
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('admin-content').style.display = 'block';
                        document.getElementById('mode-toggle').style.display = 'block';
                        hideLoadingOverlay();
                        loadAdminData();
                    }, 1500);
                } else {
                    document.getElementById('admin-content').style.display = 'none';
                    document.getElementById('login-container').style.display = 'block';
                    document.getElementById('mode-toggle').style.display = 'none';
                    hideLoadingOverlay();
                }
            }
        });
    });

    function loadAdminData() {
        database.ref('canvaLink').on('value', (snapshot) => {
            const link = snapshot.val();
            document.getElementById('current-canva-link').textContent = link || 'N/A';
            document.getElementById('new-canva-link').value = '';
        });

        database.ref('visitors/total').on('value', (snapshot) => {
            document.getElementById('total-visitors').textContent = snapshot.val() || 0;
        });

        const fullCurrentDatePath = getTodayKeyUTC();
        database.ref(`visitors/daily/${fullCurrentDatePath}`).on('value', (snapshot) => {
            document.getElementById('daily-visitors').textContent = snapshot.val() || 0;
        });

        // --- Ad Configuration Loading ---
        database.ref('adConfig').on('value', (snapshot) => {
            const config = snapshot.val() || { activeAdPattern: 'monetagOnly', totalSteps: 5 };
            document.getElementById('current-ad-pattern').textContent = config.activeAdPattern;
            document.getElementById('current-total-steps').textContent = config.totalSteps;
            document.getElementById('new-total-steps').value = config.totalSteps;

            // Update button active state
            document.querySelectorAll('.btn[id^="btn-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            if (config.activeAdPattern === 'monetagOnly') {
                document.getElementById('btn-monetag-only').classList.add('active');
            } else if (config.activeAdPattern === 'mixed') {
                document.getElementById('btn-mixed-ads').classList.add('active');
            } else if (config.activeAdPattern === 'gigapubOnly') {
                document.getElementById('btn-gigapub-only').classList.add('active');
            }
        });

        // Visitor details for charts and lists will be loaded in Phase 2
    }

    // --- Ad Control Functions ---
    function updateAdPattern(pattern) {
        database.ref('adConfig/activeAdPattern').set(pattern)
            .then(() => {
                showAdNotification(`Ad pattern updated to: ${pattern}`);
            })
            .catch((error) => {
                console.error("Error updating ad pattern:", error);
                showAdNotification("Failed to update ad pattern.");
            });
    }

    function updateTotalSteps() {
        const newStepsInput = document.getElementById('new-total-steps');
        let newSteps = parseInt(newStepsInput.value);

        if (isNaN(newSteps) || newSteps < 1 || newSteps > 10) { // Max 10 steps as a reasonable limit
            showAdNotification("Please enter a number between 1 and 10 for steps.");
            newStepsInput.value = document.getElementById('current-total-steps').textContent; // Reset to current
            return;
        }

        database.ref('adConfig/totalSteps').set(newSteps)
            .then(() => {
                showAdNotification(`Unlock steps updated to: ${newSteps}`);
            })
            .catch((error) => {
                console.error("Error updating total steps:", error);
                showAdNotification("Failed to update unlock steps.");
            });
    }

    function getChartTextColor() {
        return document.body.classList.contains('light-mode') ? '#000000' : '#ffffff';
    }

    // `selectMonthForDailyView` and `updateChartColors` will be defined and used in Phase 2
    // For now, these functions are just placeholders to avoid errors.
    function selectMonthForDailyView(monthKey, clickedElement) {
        console.log("selectMonthForDailyView will be implemented in Phase 2");
    }

    function updateChartColors(chart) {
        console.log("updateChartColors will be implemented in Phase 2");
    }

    function loginAdminWithEmailPassword() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;

        if (!email || !password) {
            showAdNotification("Please enter both email and password.");
            return;
        }

        showLoadingOverlay("Logging in...");
        document.getElementById('mode-toggle').style.display = 'none';

        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                if (user.uid === ADMIN_UID) {
                    document.getElementById('login-container').style.display = 'none';
                } else {
                    auth.signOut();
                    showAdNotification("You are not authorized to access this panel.");
                    hideLoadingOverlay();
                    document.getElementById('login-container').style.display = 'block';
                    document.getElementById('mode-toggle').style.display = 'none';
                }
            })
            .catch((error) => {
                console.error("Admin login failed:", error);
                showAdNotification("Login failed: " + error.message);
                hideLoadingOverlay();
                document.getElementById('login-container').style.display = 'block';
                document.getElementById('mode-toggle').style.display = 'none';
            });
    }

    function logoutAdmin() {
        showLoadingOverlay("Logging out...");
        document.getElementById('mode-toggle').style.display = 'none';
        auth.signOut().then(() => {
            showAdNotification("Admin logged out.");
            setTimeout(() => {
                hideLoadingOverlay();
            }, 500);
        }).catch((error) => {
            console.error("Logout error:", error);
            showAdNotification("Logout error: " + error.message);
            hideLoadingOverlay();
        });
    }

    function updateCanvaLink() {
        const newLinkInput = document.getElementById('new-canva-link');
        const newLink = newLinkInput.value.trim();

        if (newLink) {
            database.ref('canvaLink').set(newLink)
                .then(() => {
                    showAdNotification("Canva Pro link updated successfully!");
                    newLinkInput.value = '';
                })
                .catch((error) => {
                    console.error("Error updating Canva link:", error);
                    showAdNotification("Failed to update Canva Pro link.");
                });
        } else {
            showAdNotification("Please enter a valid link.");
        }
    }

    function showAdNotification(msg) {
        const el = document.getElementById('ad-notification');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => {
            el.style.display = 'none';
        }, 3000);
    }

    function showLoadingOverlay(message = "Loading...") {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.querySelector('p').textContent = message;
        loadingOverlay.style.display = 'flex';
        document.getElementById('mode-toggle').style.display = 'none';
    }

    function hideLoadingOverlay() {
        document.getElementById('loading-overlay').style.display = 'none';
    }

    function toggleMode() {
        const body = document.body;
        const btn = document.getElementById('mode-toggle');
        body.classList.toggle('light-mode');
        if (body.classList.contains('light-mode')) {
            btn.textContent = 'â˜€ï¸';
            localStorage.setItem("themeMode", "light");
        } else {
            btn.textContent = 'ðŸŒ™';
            localStorage.setItem("themeMode", "dark");
        }
        document.documentElement.style.setProperty('--h3-color', document.body.classList.contains('light-mode') ? '#000000' : '#ffffff');

        // Chart update for colors will be active in Phase 2
        // if (dailyMonthlyVisitorsChart) {
        //     updateChartColors(dailyMonthlyVisitorsChart);
        //     dailyMonthlyVisitorsChart.update();
        // }
    }

    window.addEventListener('load', () => {
        document.documentElement.style.setProperty('--h3-color', document.body.classList.contains('light-mode') ? '#000000' : '#ffffff');
    });
  </script>

</body>
</html>
