<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #6200ea;
      --secondary: #03dac5;
      --light: #ffffff;
      --dark: #121212;
      --card-bg: #1f1f1f;
      --text-color: #ffffff;
      --ad-bg: #222;
      --ad-item-bg: #333;
      --border-color: #444;
      --danger: #dc3545;
      --success: #28a745;
      --info: #17a2b8;
      --h3-color: var(--text-color);
    }

    body.light-mode {
      --dark: #ffffff;
      --card-bg: #ffffff;
      --text-color: #000000;
      --ad-bg: #f9f9f9;
      --ad-item-bg: #f1f1f1;
      --border-color: #dddddd;
      background: #ffffff !important;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--dark), #1a1a2e);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.4s ease;
      padding: 20px;
      text-align: center;
    }

    .container {
      width: 100%;
      max-width: 800px;
      background: var(--card-bg);
      border-radius: 20px;
      overflow: hidden;
      padding: 30px;
      transition: all 0.4s ease;
      position: relative;
    }

    h1 {
      font-size: 36px;
      color: var(--primary);
      margin-bottom: 30px;
      text-align: center;
    }

    .card {
      background: var(--ad-item-bg);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      border: 1px solid var(--border-color);
      text-align: left;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .card h2 {
      color: var(--secondary);
      margin-bottom: 15px;
      font-size: 26px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
    }

    .card h3 {
        color: var(--h3-color);
        margin-bottom: 10px;
        font-size: 20px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin-bottom: 0px; /* Adjusted margin */
    }

    .stat-item {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      min-height: 70px;
      text-align: center;
      word-break: break-word;
    }

    .stat-item span {
      font-size: 26px;
      font-weight: bold;
      color: var(--secondary);
      margin-top: 5px;
    }

    .input-with-button {
        display: flex;
        align-items: center;
        width: 100%;
        margin-top: 5px;
        margin-bottom: 5px;
    }

    .card input[type="text"], .card input[type="password"], .card select, .card input[type="number"] {
      flex-grow: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 16px;
      margin-right: 0px;
    }

    .card input[type="text"]:last-child {
        margin-right: 0;
    }

    .btn {
      background: var(--secondary);
      color: #000;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 0px;
      transition: background 0.2s ease, transform 0.2s ease;
      font-size: 16px;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      margin-top: 10px;
    }
    /* MODIFIED: Reverted .btn-success and created a new .btn-save-centered */
    .btn-success {
        background: var(--success);
        color: #fff;
        padding: 8px 15px;
        font-size: 14px;
        margin-left: 10px;
    }
    .btn-save-centered {
        background: var(--primary); /* Same color as btn-primary */
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 20px; /* Smaller padding */
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s ease, transform 0.2s ease;
        font-size: 15px; /* Smaller font size */
        display: block; /* Make it a block element */
        margin: 10px auto 0 auto; /* Center it horizontally with margin-top */
    }


    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    #login-container {
      text-align: center;
      padding: 50px 20px;
    }

    #login-container input {
        display: block;
        margin: 10px auto;
        width: 80%;
        max-width: 300px;
        padding: 14px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-color);
        font-size: 17px;
    }

    #login-button {
      background: var(--primary);
      color: #fff;
      padding: 14px 30px;
      border-radius: 10px;
      font-size: 19px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: background 0.2s ease;
      margin-top: 20px;
    }

    #login-button:hover {
      filter: brightness(1.2);
    }

    /* Initially hide everything except loading, or login based on JS */
    #admin-content, #login-container {
      display: none;
    }

    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1001;
        color: var(--light);
        font-size: 24px;
        flex-direction: column;
    }

    .spinner {
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-top: 8px solid var(--primary);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }


    #mode-toggle {
      position: absolute;
      top: 15px;
      right: 30px;
      padding: 5px;
      background: transparent;
      color: var(--primary);
      border: none;
      border-radius: 100px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
      z-index: 1100;
      display: none;
    }
    #mode-toggle:hover {
      background-color: rgba(98, 0, 234, 0.1);
    }

    .ad-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: var(--light);
      padding: 20px 40px;
      border-radius: 12px;
      z-index: 1000;
      display: none;
      font-size: 18px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }

    .monthly-list-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 5px;
        border-bottom: 1px dashed var(--border-color);
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .monthly-list-item:hover {
        background-color: rgba(3, 218, 197, 0.05);
    }
    .monthly-list-item:last-child {
        border-bottom: none;
    }
    .monthly-list-item span {
        font-weight: 500;
        font-size: 15px;
    }
    .monthly-list-item.selected {
        background-color: rgba(3, 218, 197, 0.15);
        border-radius: 5px;
        padding: 10px;
    }
    #daily-stats-list, #monthly-stats-list {
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 10px;
        background-color: var(--card-bg);
    }

    /* MODIFIED: New styles for the daily details table */
    .daily-details-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 14px; /* Slightly smaller font for thin appearance */
    }
    .daily-details-table th, .daily-details-table td {
        border: 1px solid var(--border-color);
        padding: 6px 8px; /* Reduced padding for thin appearance */
        text-align: center;
        vertical-align: middle; /* Align text vertically in middle */
    }
    .daily-details-table th {
        background-color: var(--primary);
        color: var(--light);
        font-weight: bold;
    }
    .daily-details-table tr:nth-child(even) {
        background-color: var(--ad-item-bg);
    }
    .daily-details-table tr:hover {
        background-color: rgba(3, 218, 197, 0.05);
    }


    .monthly-daily-flex {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    /* --- CHART CONTAINER STYLES --- */
    .chart-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin-top: 15px;
    }
    .chart-container canvas {
      max-width: 100%;
      height: 100% !important;
      width: 100% !important;
    }

    /* Override Chart.js default font color for dark mode */
    body:not(.light-mode) .chartjs-render-monitor,
    body:not(.light-mode) .chartjs-render-monitor canvas {
        color: var(--text-color) !important;
    }

    /* Ad pattern buttons specific styles - UPDATED */
    .ad-pattern-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
    }
    .ad-pattern-buttons button {
        background-color: #555;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: background-color 0.2s ease;
        flex: 1 1 auto; /* Allow buttons to grow and shrink, but not have a fixed max-width */
        max-width: 120px; /* Still apply a max-width to keep them from becoming too wide */
    }
    .ad-pattern-buttons button.active {
        background-color: var(--primary);
    }
    .ad-pattern-buttons button:hover:not(.active) {
        background-color: #777;
    }
    .ad-step-control {
        margin-top: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
    }
    .ad-step-control label {
        font-weight: bold;
        white-space: nowrap;
    }
    .ad-step-control input {
        width: 60px;
        text-align: center;
        padding: 8px;
        font-size: 14px;
    }

    /* New styles for Ad Network Toggle Buttons */
    .ad-network-toggles {
        display: flex;
        flex-direction: row; /* Changed to row for horizontal display */
        flex-wrap: wrap; /* Allow wrapping */
        justify-content: center; /* Center buttons horizontally */
        gap: 8px; /* Reduced gap */
        margin-top: 15px;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background-color: var(--card-bg);
    }
    .ad-network-toggles label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 10px; /* Smaller padding */
        background-color: var(--ad-item-bg);
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        flex: 1 1 18%; /* Make each label take up about 18% width for ~5 per line */
        max-width: 150px; /* Max width to keep them from getting too wide */
        min-width: 100px; /* Minimum width for responsiveness */
        height: 45px; /* Fixed height for consistency */
    }
    .ad-network-toggles label:hover {
        background-color: rgba(3, 218, 197, 0.05);
    }
    .ad-network-toggles label span {
        font-weight: bold;
        color: var(--text-color);
        font-size: 14px; /* Smaller font size */
    }
    .ad-network-toggles input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 35px; /* Smaller toggle switch */
        height: 18px; /* Smaller toggle switch */
        background: #ccc;
        border-radius: 9px; /* Half of height */
        position: relative;
        cursor: pointer;
        outline: none;
        transition: background-color 0.2s ease;
        flex-shrink: 0; /* Prevent checkbox from shrinking */
    }
    .ad-network-toggles input[type="checkbox"]::before {
        content: '';
        position: absolute;
        width: 14px; /* Smaller circle */
        height: 14px; /* Smaller circle */
        border-radius: 50%;
        background: white;
        top: 2px;
        left: 2px;
        transition: left 0.2s ease;
    }
    .ad-network-toggles input[type="checkbox"]:checked {
        background: var(--success);
    }
    .ad-network-toggles input[type="checkbox"]:checked::before {
        left: 19px; /* Adjusted left for smaller width (35-14-2=19) */
    }

    /* Hide ad network toggles by default, show only for Pattern 2 */
    #ad-network-toggle-controls {
        display: none;
    }

    /* New toggle switch styles for Facebook Follow */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--success);
    }

    input:focus + .slider {
        box-shadow: 0 0 1px var(--success);
    }

    input:checked + .slider:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(26px);
    }

    /* --- Responsive Adjustments --- */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .container {
        padding: 20px;
        border-radius: 15px;
      }

      h1 {
        font-size: 30px;
        margin-bottom: 25px;
      }

      .card {
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .card h2 {
        font-size: 22px;
        margin-bottom: 12px;
        padding-bottom: 8px;
      }

      .card h3 {
        font-size: 18px;
      }

      .stat-grid {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 5px;
      }

      .stat-item {
        padding: 8px;
        font-size: 11px;
        min-height: 60px;
      }

      .stat-item span {
        font-size: 22px;
      }

      .card input[type="text"], .card input[type="password"], .card select, .card input[type="number"] {
        width: 100%;
        padding: 10px;
        font-size: 15px;
        margin-right: 0;
      }

      .input-with-button {
        flex-direction: column;
        align-items: stretch;
      }

      .input-with-button input {
        margin-right: 0;
        margin-bottom: 0px;
      }

      .btn {
        width: 100%;
        margin-right: 0;
        margin-top: 10px;
        padding: 10px 15px;
        font-size: 15px;
      }

      .btn-primary + .btn {
        margin-top: 10px;
      }

      #login-container input {
        width: 90%;
        max-width: none;
        padding: 12px;
        font-size: 16px;
      }

      #login-button {
        padding: 12px 25px;
        font-size: 17px;
      }

      #mode-toggle {
        right: 20px;
        font-size: 16px;
        padding: 3px;
      }

      .chart-container {
        height: 200px;
      }

      .monthly-daily-flex {
          grid-template-columns: 1fr;
          gap: 15px;
      }

      .ad-notification {
        width: 90%;
        padding: 15px 25px;
        font-size: 16px;
      }
      .ad-step-control {
        flex-direction: row;
        align-items: center;
        justify-content: center;
      }
      .ad-step-control label {
        margin-bottom: 0;
      }
      .ad-step-control input {
        width: 50px;
      }
      .ad-step-control .btn-success {
        margin-top: 0;
      }
      .ad-pattern-buttons button {
        flex: 1 1 30%;
        max-width: unset;
      }
      .ad-network-toggles {
          flex-direction: row; /* Still keep row for wrap effect */
          justify-content: space-around; /* Distribute evenly */
          padding: 8px;
      }
      .ad-network-toggles label {
          flex: 1 1 45%; /* Two per row on small screens */
          max-width: calc(50% - 8px); /* Account for gap */
          height: 40px; /* Slightly smaller height */
      }
      .ad-network-toggles label span {
          font-size: 13px;
      }
      .ad-network-toggles input[type="checkbox"] {
          width: 30px;
          height: 16px;
      }
      .ad-network-toggles input[type="checkbox"]::before {
          width: 12px;
          height: 12px;
          top: 2px;
          left: 2px;
      }
      .ad-network-toggles input[type="checkbox"]:checked::before {
          left: 16px; /* 30-12-2=16 */
      }

      /* MODIFIED: Center the new save button on smaller screens */
      .btn-save-centered {
          width: 100%;
          margin-top: 10px;
          padding: 10px 15px;
          font-size: 15px;
      }
    }
  </style>

</head>
<body>
  <div class="ad-notification" id="ad-notification"></div>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <p>Loading Admin Panel...</p>
  </div>
  <div class="container">
    <button id="mode-toggle" onclick="toggleMode()">ðŸŒ™</button>

<div id="login-container">
  <h1>Admin Login</h1>
  <input type="text" id="admin-email" placeholder="Admin Email" autocomplete="username">
  <input type="password" id="admin-password" placeholder="Password" autocomplete="current-password">
  <button id="login-button" onclick="loginAdminWithEmailPassword()">Login</button>
</div>

<div id="admin-content">
  <h1>Admin Panel</h1>

  <div class="card">
    <h2>Visitor Overview</h2>
    <div class="stat-grid">
      <div class="stat-item">
        Total Views
        <span id="total-visitors">0</span>
      </div>
      <div class="stat-item">
        Today's Views (UTC)
        <span id="daily-visitors">0</span>
      </div>
    </div>
    <div class="stat-grid" style="margin-top: 15px;"> <!-- Added margin-top for separation -->
      <div class="stat-item">
        Total Ads Views
        <span id="total-ads-shown">0</span>
      </div>
      <div class="stat-item">
        Today's Ads Views
        <span id="daily-ads-shown">0</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Canva Pro Link</h2>
    <p>Canva Pro Link: <span id="current-canva-link" style="color: var(--secondary); word-break: break-all;">Loading...</span></p>
    <label for="new-canva-link" style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold;">Enter New Link:</label>
    <div class="input-with-button">
        <input type="text" id="new-canva-link" placeholder="https://www.canva.com/brand/join?token=..." value="">
    </div>
    <button class="btn btn-primary" onclick="updateCanvaLink()">Update Link</button>
  </div>

  <div class="card">
    <h2>Ad Settings</h2>
    <div class="ad-step-control">
        <label for="total-ad-steps">Total Ad Steps:</label>
        <input type="number" id="total-ad-steps" min="1" max="10" value="0" onchange="updateTotalAdSteps()">
        <button class="btn btn-success" onclick="saveTotalAdSteps()">Save</button>
    </div>
    <div class="ad-pattern-buttons">
        <button id="ad-pattern-1-btn" onclick="selectAdPattern(1)">Monetag</button>
        <button id="ad-pattern-3-btn" onclick="selectAdPattern(3)">Gigapub</button>
        <button id="ad-pattern-2-btn" onclick="selectAdPattern(2)">All-Network</button>
    </div>

    <div id="ad-network-toggle-controls" class="ad-network-toggles">
        <label>
            <span>Monetag</span>
            <input type="checkbox" id="toggle-monetag" onchange="toggleAdNetwork('monetag')">
        </label>
        <label>
            <span>Gigapub</span>
            <input type="checkbox" id="toggle-gigapub" onchange="toggleAdNetwork('gigapub')">
        </label>
        <label>
            <span>Adexora</span>
            <input type="checkbox" id="toggle-adexora" onchange="toggleAdNetwork('adexora')">
        </label>
        <label>
            <span>Adexium</span>
            <input type="checkbox" id="toggle-adexium" onchange="toggleAdNetwork('adexium')">
        </label>
        <label>
            <span>Adextra</span>
            <input type="checkbox" id="toggle-adextra" onchange="toggleAdNetwork('adextra')">
        </label>
    </div>
  </div>

  <!-- NEW: Facebook Follow Settings Card -->
  <div class="card">
    <h2>Step Ad Settings</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <label for="toggle-facebook-follow" style="font-weight: bold;">Enable Step Ad</label>
        <label class="toggle-switch">
            <input type="checkbox" id="toggle-facebook-follow" onchange="toggleFacebookFollow()">
            <span class="slider"></span>
        </label>
    </div>
    <label for="facebook-follow-title" style="display: block; margin-bottom: 5px; font-weight: bold;">Enter New Title:</label>
    <div class="input-with-button" style="margin-bottom: 10px;">
        <input type="text" id="facebook-follow-title" placeholder="type a Title">
    </div>
    <button class="btn btn-save-centered" onclick="saveFacebookFollowTitle()">Save Title</button> <!-- MODIFIED -->

    <label for="facebook-profile-link" style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold;">Enter New Link:</label> <!-- MODIFIED margin-top -->
    <div class="input-with-button">
        <input type="text" id="facebook-profile-link" placeholder="type a URL">
    </div>
    <button class="btn btn-save-centered" onclick="saveFacebookProfileLink()">Save Link</button> <!-- MODIFIED -->
  </div>

  <!-- NEW: Promotional Ad Space Settings Card -->
  <div class="card">
    <h2>Ad Space Settings</h2>
    <label for="promo-ad-title" style="display: block; margin-bottom: 5px; font-weight: bold;">Enter New Ad Title:</label>
    <div class="input-with-button" style="margin-bottom: 10px;">
        <input type="text" id="promo-ad-title" placeholder="type a Ad Title">
    </div>
    <button class="btn btn-save-centered" onclick="savePromotionalAdTitle()">Save Ad Title</button> <!-- MODIFIED -->

    <label for="promo-ad-link" style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold;">Enter New Ad Link:</label> <!-- MODIFIED margin-top -->
    <div class="input-with-button">
        <input type="text" id="promo-ad-link" placeholder="type a Ad Link">
    </div>
    <button class="btn btn-save-centered" onclick="savePromotionalAdLink()">Save Ad Link</button> <!-- MODIFIED -->
  </div>

  <div class="card">
    <h2>Monthly Daily Statistics</h2>
    <div class="chart-container">
        <canvas id="daily-monthly-visitors-chart"></canvas>
    </div>
  </div>

  <div class="card">
    <h2>Visitor Details</h2>
    <div class="monthly-daily-flex">
        <div style="flex: 1;">
            <h3>Select Month:</h3>
            <div id="monthly-stats-list">
                <p>Loading monthly data...</p>
            </div>
        </div>
        <div style="flex: 1;">
            <h3>Daily for <span id="selected-month-display"></span>:</h3>
            <div id="daily-stats-list">
                <p>Select a month to see daily views and ads shown.</p>
            </div>
        </div>
    </div>
  </div>


<button class="btn btn-danger" onclick="logoutAdmin()" style="margin-top: 20px;">Logout</button>

</div>

</div>
  <script>
    // Firebase configuration (replace with your actual config)
   const firebaseConfig = {
  apiKey: "AIzaSyBOF9MywuavGgXCkm3ktWNaEU3j7ZfycU4", // REPLACE THIS
  authDomain: "test-9c2fe.firebaseapp.com",        // REPLACE THIS
  databaseURL: "https://test-9c2fe-default-rtdb.firebaseio.com", // REPLACE THIS
  projectId: "test-9c2fe",                        // REPLACE THIS
  storageBucket: "test-9c2fe.firebasestorage.app", // REPLACE THIS
  messagingSenderId: "940783022173",              // REPLACE THIS
  appId: "1:940783022173:web:72826d42d138be8a219db4" // REPLACE THIS
};


// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

const ADMIN_UID = "ypVaPoPt6LMKW9ZEo6KrdFV6DNR2"; // REPLACE THIS with your actual admin UID
let dailyMonthlyVisitorsChart;
let currentSelectedMonth = '';
let isInitialAuthCheckComplete = false;

// Caching variables for data loaded once - now these will be updated in real-time listeners
let allMonthlyData = {};
let allDailyVisitorData = {};
let allDailyAdsData = {};

// Helper function to get today's date in YYYY-MM-DD UTC format
function getTodayKeyUTC() {
const now = new Date();
const year = now.getUTCFullYear();
const month = (now.getUTCMonth() + 1).toString().padStart(2, '0');
const day = now.getUTCDate().toString().padStart(2, '0');
return `${year}-${month}-${day}`;
}

// Helper function to get current month key in YYYY-MM UTC format
function getCurrentMonthKeyUTC() {
    const now = new Date();
    const year = now.getUTCFullYear();
    const month = (now.getUTCMonth() + 1).toString().padStart(2, '0');
    return `${year}-${month}`;
}


// Helper function to format a date in YYYY-MM-DD UTC format
function getFormattedDateUTC(year, month, day) {
const date = new Date(Date.UTC(year, month - 1, day));
const options = { month: 'long', day: 'numeric', year: 'numeric', timeZone: 'UTC' }; // Changed to include year
return date.toLocaleDateString('en-US', options);
}

// Helper function to format a month in YYYY-MM UTC format
function getFormattedMonthUTC(year, month) {
const date = new Date(Date.UTC(year, month - 1, 1));
const options = { year: 'numeric', month: 'long', timeZone: 'UTC' };
return date.toLocaleDateString('en-US', options);
}

// --- Authentication and Loading ---
window.addEventListener("DOMContentLoaded", () => {
const savedMode = localStorage.getItem("themeMode");
if (savedMode === "light") {
document.body.classList.add("light-mode");
document.getElementById("mode-toggle").textContent = "â˜€ï¸";
}

showLoadingOverlay();

auth.onAuthStateChanged((user) => {
if (!isInitialAuthCheckComplete) {
if (user && user.uid === ADMIN_UID) {
setTimeout(() => {
document.getElementById('login-container').style.display = 'none';
document.getElementById('admin-content').style.display = 'block';
document.getElementById('mode-toggle').style.display = 'block';
hideLoadingOverlay();
loadAdminData(); // Initial data load
}, 1500);
} else {
setTimeout(() => {
document.getElementById('login-container').style.display = 'block';
document.getElementById('admin-content').style.display = 'none';
document.getElementById('mode-toggle').style.display = 'none';
hideLoadingOverlay();
}, 1000);
}
isInitialAuthCheckComplete = true;
} else {
if (user && user.uid === ADMIN_UID) {
setTimeout(() => {
document.getElementById('login-container').style.display = 'none';
document.getElementById('admin-content').style.display = 'block';
document.getElementById('mode-toggle').style.display = 'block';
hideLoadingOverlay();
// No need to call loadAdminData() again here if already logged in and data is cached
}, 1500);
} else {
document.getElementById('admin-content').style.display = 'none';
document.getElementById('login-container').style.display = 'block';
document.getElementById('mode-toggle').style.display = 'none';
hideLoadingOverlay();
}
}
});

});

function showLoadingOverlay(message = "Loading...") {
const loadingOverlay = document.getElementById('loading-overlay');
loadingOverlay.querySelector('p').textContent = message;
loadingOverlay.style.display = 'flex';
document.getElementById('mode-toggle').style.display = 'none';
}

function hideLoadingOverlay() {
document.getElementById('loading-overlay').style.display = 'none';
}

function loginAdminWithEmailPassword() {
const email = document.getElementById('admin-email').value;
const password = document.getElementById('admin-password').value;

if (!email || !password) {
showAdNotification("Please enter both email and password.");
return;
}

showLoadingOverlay("Logging in...");
document.getElementById('mode-toggle').style.display = 'none';

auth.signInWithEmailAndPassword(email, password)
.then((userCredential) => {
const user = userCredential.user;
if (user.uid === ADMIN_UID) {
document.getElementById('login-container').style.display = 'none';
// Data will be loaded by onAuthStateChanged once the user is verified
} else {
auth.signOut();
showAdNotification("You are not authorized to access this panel.");
hideLoadingOverlay();
document.getElementById('login-container').style.display = 'block';
document.getElementById('mode-toggle').style.display = 'none';
}
})
.catch((error) => {
console.error("Admin login failed:", error);
showAdNotification("Login failed: " + error.message);
hideLoadingOverlay();
document.getElementById('login-container').style.display = 'block';
document.getElementById('mode-toggle').style.display = 'none';
});

}

function logoutAdmin() {
showLoadingOverlay("Logging out...");
document.getElementById('mode-toggle').style.display = 'none';
auth.signOut().then(() => {
showAdNotification("Admin logged out.");
setTimeout(() => {
hideLoadingOverlay();
}, 500);
}).catch((error) => {
console.error("Logout error:", error);
showAdNotification("Logout error: " + error.message);
hideLoadingOverlay();
});
}

// --- General UI and Data Loading ---
function loadAdminData() {
// Load Canva Link
database.ref('canvaLink').on('value', (snapshot) => {
const link = snapshot.val();
document.getElementById('current-canva-link').textContent = link || 'N/A';
document.getElementById('new-canva-link').value = '';
});

// Load Visitor Overview
database.ref('visitors/total').on('value', (snapshot) => {
document.getElementById('total-visitors').textContent = snapshot.val() || 0;
});

const fullCurrentDatePath = getTodayKeyUTC();
database.ref(`visitors/daily/${fullCurrentDatePath}`).on('value', (snapshot) => {
document.getElementById('daily-visitors').textContent = snapshot.val() || 0;
});

// Load Total Ads Shown
database.ref('visitors/ads/total').on('value', (snapshot) => {
document.getElementById('total-ads-shown').textContent = snapshot.val() || 0;
});

// Load Today's Ads Shown
database.ref(`visitors/ads/daily/${fullCurrentDatePath}`).on('value', (snapshot) => {
document.getElementById('daily-ads-shown').textContent = snapshot.val() || 0;
});

// Load Ad Settings (pattern, totalSteps, and network toggles)
database.ref('adSettings').on('value', (snapshot) => {
const settings = snapshot.val();
const currentPattern = settings ? settings.pattern : 1; // Default to pattern 1
const currentSteps = settings ? settings.totalSteps : 5; // Default to 5 steps
const adNetworkStates = settings && settings.adNetworks ? settings.adNetworks : {
monetag: true,
gigapub: true,
adexora: true,
adexium: true,
adextra: true,
};

// Update UI for ad pattern buttons
document.querySelectorAll('.ad-pattern-buttons button').forEach(button => {
button.classList.remove('active');
});
document.getElementById(`ad-pattern-${currentPattern}-btn`).classList.add('active');

// Show/hide ad network toggles based on selected pattern
const adNetworkToggleControls = document.getElementById('ad-network-toggle-controls');
if (currentPattern === 2) {
adNetworkToggleControls.style.display = 'flex';
} else {
adNetworkToggleControls.style.display = 'none';
}

// Update UI for ad network toggle checkboxes
for (const network in adNetworkStates) {
const checkbox = document.getElementById(`toggle-${network}`);
if (checkbox) {
checkbox.checked = adNetworkStates[network];
}
}

// Update UI for total ad steps
const totalAdStepsInput = document.getElementById('total-ad-steps');
totalAdStepsInput.value = currentSteps;

});

// NEW: Load Facebook Follow Settings
database.ref('facebookFollowSettings').on('value', (snapshot) => {
    const settings = snapshot.val() || {};
    document.getElementById('toggle-facebook-follow').checked = settings.enabled || false;
    document.getElementById('facebook-follow-title').value = settings.title || '';
    document.getElementById('facebook-profile-link').value = settings.link || '';
});

// NEW: Load Promotional Ad Space Settings
database.ref('promotionalAdSpace').on('value', (snapshot) => {
    const settings = snapshot.val() || {};
    document.getElementById('promo-ad-title').value = settings.title || '';
    document.getElementById('promo-ad-link').value = settings.link || '';
});


// Load Monthly Visitor Data - Now using .on() for real-time updates and auto-selecting current month
database.ref('visitors/monthly').orderByKey().on('value', (snapshot) => { // Changed .once to .on
    const monthlyStatsList = document.getElementById('monthly-stats-list');
    monthlyStatsList.innerHTML = '';

    if (snapshot.exists()) {
        const data = snapshot.val();
        allMonthlyData = data; // Cache the monthly data
        const months = Object.keys(data).sort((a, b) => {
            const [yearA, monthA] = a.split('-').map(Number);
            const [yearB, monthB] = b.split('-').map(Number);
            if (yearA !== yearB) return yearB - yearA;
            return monthB - monthA;
        });

        const currentMonthKey = getCurrentMonthKeyUTC();
        let monthToSelect = currentMonthKey; // Default to current month

        // If current month is not in data, select the latest available month
        if (!months.includes(currentMonthKey) && months.length > 0) {
            monthToSelect = months[0]; // The latest month is at index 0 due to sort order
        } else if (months.length === 0) {
            monthToSelect = ''; // No months available
        }


        months.forEach(monthKey => {
            const [year, monthNum] = monthKey.split('-');
            const formattedMonthName = getFormattedMonthUTC(parseInt(year), parseInt(monthNum));

            const div = document.createElement('div');
            div.className = 'monthly-list-item';
            div.innerHTML = `<span>${formattedMonthName}</span><span>${data[monthKey]} views</span>`;
            div.onclick = () => selectMonthForDailyView(monthKey, div);
            monthlyStatsList.appendChild(div);

            // If this is the month to select, mark it
            if (monthKey === monthToSelect) {
                currentSelectedMonth = monthKey; // Update currentSelectedMonth
            }
        });

        // Trigger selection of the identified month (current or latest)
        if (monthToSelect) {
            const elementToSelect = monthlyStatsList.querySelector(`[onclick*="${monthToSelect}"]`);
            if (elementToSelect) {
                selectMonthForDailyView(monthToSelect, elementToSelect);
            }
        }

    } else {
        monthlyStatsList.innerHTML = '<p>No monthly data available yet.</p>';
        if (dailyMonthlyVisitorsChart) {
            dailyMonthlyVisitorsChart.destroy();
            dailyMonthlyVisitorsChart = null;
        }
        document.getElementById('selected-month-display').textContent = 'N/A';
        document.getElementById('daily-stats-list').innerHTML = '<p>No daily data available for this month.</p>';
    }
}, (error) => {
    console.error("Error loading monthly data:", error);
    document.getElementById('monthly-stats-list').innerHTML = `<p>Error loading monthly data: ${error.message}</p>`;
});


// Load all daily visitor data in real-time
database.ref('visitors/daily').on('value', (snapshot) => {
    allDailyVisitorData = snapshot.val() || {};
    // If a month is currently selected, refresh its daily view with new data
    if (currentSelectedMonth) {
        const selectedElement = document.querySelector(`.monthly-list-item.selected`);
        selectMonthForDailyView(currentSelectedMonth, selectedElement);
    }
}, (error) => {
    console.error("Error loading all daily visitor data:", error);
});

// Load all daily ads data in real-time
database.ref('visitors/ads/daily').on('value', (snapshot) => {
    allDailyAdsData = snapshot.val() || {};
    // If a month is currently selected, refresh its daily view with new data
    if (currentSelectedMonth) {
        const selectedElement = document.querySelector(`.monthly-list-item.selected`);
        selectMonthForDailyView(currentSelectedMonth, selectedElement);
    }
}, (error) => {
    console.error("Error loading all daily ads data:", error);
});

} // End of loadAdminData

// --- Ad Pattern and Steps Control ---
function selectAdPattern(patternNumber) {
database.ref('adSettings/pattern').set(patternNumber)
.then(() => {
// UI will update via the 'on' listener for adSettings
})
.catch(error => {
console.error("Error setting ad pattern:", error);
showAdNotification("Failed to set ad pattern.");
});
}

function updateTotalAdSteps() {
const input = document.getElementById('total-ad-steps');
let value = parseInt(input.value);
if (isNaN(value) || value < 1) {
value = 1;
} else if (value > 10) { // Max steps to prevent excessive ads
value = 10;
}
input.value = value;
}

function saveTotalAdSteps() {
const totalSteps = parseInt(document.getElementById('total-ad-steps').value);
database.ref('adSettings/totalSteps').set(totalSteps)
.then(() => {
showAdNotification("Ad steps saved successfully!");
})
.catch(error => {
console.error("Error setting total ad steps:", error);
showAdNotification("Failed to save total ad steps.");
});
}

function toggleAdNetwork(networkName) {
const checkbox = document.getElementById(`toggle-${networkName}`);
const isEnabled = checkbox.checked;
database.ref(`adSettings/adNetworks/${networkName}`).set(isEnabled)
.then(() => {
showAdNotification(`${networkName} ads ${isEnabled ? 'enabled' : 'disabled'}.`);
})
.catch(error => {
console.error(`Error toggling ${networkName} ads:`, error);
showAdNotification(`Failed to toggle ${networkName} ads.`);
checkbox.checked = !isEnabled; // Revert UI on error
});
}

function updateCanvaLink() {
const newLinkInput = document.getElementById('new-canva-link');
const newLink = newLinkInput.value.trim();

if (newLink) {
database.ref('canvaLink').set(newLink)
.then(() => {
showAdNotification("Link updated successfully!");
newLinkInput.value = '';
})
.catch((error) => {
console.error("Error updating Canva link:", error);
showAdNotification("Failed to update Canva Pro link.");
});
} else {
showAdNotification("Please enter a valid link.");
}

}

// NEW: Facebook Follow Settings Functions
function toggleFacebookFollow() {
    const isEnabled = document.getElementById('toggle-facebook-follow').checked;
    database.ref('facebookFollowSettings/enabled').set(isEnabled)
        .then(() => showAdNotification(`Step Ad is now ${isEnabled ? 'enabled' : 'disabled'}.`))
        .catch(error => {
            console.error("Error toggling Facebook Follow:", error);
            showAdNotification("Failed to toggle Facebook Follow.");
        });
}

function saveFacebookFollowTitle() {
    const title = document.getElementById('facebook-follow-title').value.trim();
    database.ref('facebookFollowSettings/title').set(title)
        .then(() => showAdNotification("Title updated successfully!"))
        .catch(error => {
            console.error("Error updating Facebook Follow Title:", error);
            showAdNotification("Failed to update Facebook Follow Title.");
        });
}

function saveFacebookProfileLink() {
    const link = document.getElementById('facebook-profile-link').value.trim();
    database.ref('facebookFollowSettings/link').set(link)
        .then(() => showAdNotification("Link updated successfully!"))
        .catch(error => {
            console.error("Error updating Facebook Profile Link:", error);
            showAdNotification("Failed to update Facebook Profile Link.");
        });
}

// NEW: Promotional Ad Space Settings Functions
function savePromotionalAdTitle() {
    const title = document.getElementById('promo-ad-title').value.trim();
    database.ref('promotionalAdSpace/title').set(title)
        .then(() => showAdNotification("Ad Title updated successfully!"))
        .catch(error => {
            console.error("Error updating Promotional Ad Title:", error);
            showAdNotification("Failed to update Promotional Ad Title.");
        });
}

function savePromotionalAdLink() {
    const link = document.getElementById('promo-ad-link').value.trim();
    database.ref('promotionalAdSpace/link').set(link)
        .then(() => showAdNotification("Ad Link updated successfully!"))
        .catch(error => {
            console.error("Error updating Promotional Ad Link:", error);
            showAdNotification("Failed to update Promotional Ad Link.");
        });
}


// --- Utility Functions ---
function showAdNotification(msg) {
const el = document.getElementById('ad-notification');
el.textContent = msg;
el.style.display = 'block';
setTimeout(() => {
el.style.display = 'none';
}, 3000);
}

function toggleMode() {
const body = document.body;
const btn = document.getElementById('mode-toggle');
body.classList.toggle('light-mode');
if (body.classList.contains('light-mode')) {
btn.textContent = 'â˜€ï¸';
localStorage.setItem("themeMode", "light");
} else {
btn.textContent = 'ðŸŒ™';
localStorage.setItem("themeMode", "dark");
}
document.documentElement.style.setProperty('--h3-color', document.body.classList.contains('light-mode') ? '#000000' : '#ffffff');

if (dailyMonthlyVisitorsChart) {
updateChartColors(dailyMonthlyVisitorsChart);
dailyMonthlyVisitorsChart.update();
}

}

// --- Chart and Visitor Details ---
function getChartTextColor() {
return document.body.classList.contains('light-mode') ? '#000000' : '#ffffff';
}

function selectMonthForDailyView(monthKey, clickedElement) {
    currentSelectedMonth = monthKey; // Ensure this is always updated when a month is selected

    const [year, monthNum] = monthKey.split('-');
    document.getElementById('selected-month-display').textContent = getFormattedMonthUTC(parseInt(year), parseInt(monthNum));

    document.querySelectorAll('.monthly-list-item').forEach(item => item.classList.remove('selected'));
    if (clickedElement) {
        clickedElement.classList.add('selected');
    }

    const dailyStatsList = document.getElementById('daily-stats-list');
    dailyStatsList.innerHTML = '<p>Loading daily data...</p>';

    const dayLabels = [];
    const fullDateLabels = [];
    const dayViews = [];
    const dayAdsShown = [];

    const visitorsDataForMonth = {};
    const adsDataForMonth = {};

    // Filter cached data for the selected month
    for (const dateKey in allDailyVisitorData) {
        if (dateKey.startsWith(monthKey)) {
            visitorsDataForMonth[dateKey] = allDailyVisitorData[dateKey];
        }
    }
    for (const dateKey in allDailyAdsData) {
        if (dateKey.startsWith(monthKey)) {
            adsDataForMonth[dateKey] = allDailyAdsData[dateKey];
        }
    }

    const allDatesInMonth = Array.from(new Set([
        ...Object.keys(visitorsDataForMonth),
        ...Object.keys(adsDataForMonth)
    ]))
    .filter(fullDateKey => fullDateKey.startsWith(monthKey))
    .sort();

    dailyStatsList.innerHTML = '';

    if (allDatesInMonth.length > 0) {
        const table = document.createElement('table');
        table.className = 'daily-details-table';
        table.innerHTML = `<thead> <tr> <th>Date</th> <th>Views</th> <th>Ads View</th> </tr> </thead> <tbody> </tbody>`;
        const tbody = table.querySelector('tbody');

        allDatesInMonth.forEach(fullDateKey => {
            const [dayYear, dayMonth, dayDay] = fullDateKey.split('-').map(Number);

            dayLabels.push(dayDay.toString());
            fullDateLabels.push(getFormattedDateUTC(dayYear, dayMonth, dayDay));

            const views = visitorsDataForMonth[fullDateKey] || 0;
            const adsShown = adsDataForMonth[fullDateKey] || 0;

            dayViews.push(views);
            dayAdsShown.push(adsShown);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${dayDay}</td>
                <td>${views}</td>
                <td>${adsShown}</td>
            `;
            tbody.appendChild(row);
        });
        dailyStatsList.appendChild(table);

    } else {
        dailyStatsList.innerHTML = '<p>No daily data available for this month.</p>';
    }

    // Update or create chart as before
    if (dailyMonthlyVisitorsChart) {
        dailyMonthlyVisitorsChart.data.labels = dayLabels;
        dailyMonthlyVisitorsChart.data.datasets[0].data = dayViews;
        dailyMonthlyVisitorsChart.data.datasets[1].data = dayAdsShown;
        dailyMonthlyVisitorsChart.data.datasets[0].fullDateLabels = fullDateLabels;
        dailyMonthlyVisitorsChart.data.datasets[1].fullDateLabels = fullDateLabels;

        dailyMonthlyVisitorsChart.options.plugins.title.text = `Daily Views & Ads Views for ${getFormattedMonthUTC(parseInt(year), parseInt(monthNum))}`;
        dailyMonthlyVisitorsChart.data.datasets[1].label = 'Daily Ads Views';

        updateChartColors(dailyMonthlyVisitorsChart);
        dailyMonthlyVisitorsChart.update();

    } else {
        const ctx = document.getElementById('daily-monthly-visitors-chart').getContext('2d');
        dailyMonthlyVisitorsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dayLabels,
                datasets: [
                    {
                        label: 'Daily Views',
                        data: dayViews,
                        backgroundColor: 'rgba(3, 218, 197, 0.4)',
                        borderColor: 'rgba(3, 218, 197, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHitRadius: 10,
                        pointBackgroundColor: 'rgba(3, 218, 197, 1)',
                        fullDateLabels: fullDateLabels
                    },
                    {
                        label: 'Daily Ads Views',
                        data: dayAdsShown,
                        backgroundColor: 'rgba(98, 0, 234, 0.4)',
                        borderColor: 'rgba(98, 0, 234, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHitRadius: 10,
                        pointBackgroundColor: 'rgba(98, 0, 234, 1)',
                        fullDateLabels: fullDateLabels
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Daily Views & Ads Views for ${getFormattedMonthUTC(parseInt(year), parseInt(monthNum))}`,
                        color: getChartTextColor(),
                        font: {
                            size: 18
                        }
                    },
                    legend: {
                        labels: {
                            color: getChartTextColor()
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const fullDate = tooltipItems[0].dataset.fullDateLabels[tooltipItems[0].dataIndex];
                                return fullDate;
                            },
                            label: function(tooltipItem) {
                                return `${tooltipItem.dataset.label}: ${tooltipItem.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: getChartTextColor(),
                            precision: 0
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: getChartTextColor()
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
    }
}

function updateChartColors(chart) {
const textColor = getChartTextColor();
chart.options.scales.x.ticks.color = textColor;
chart.options.scales.y.ticks.color = textColor;
chart.options.plugins.title.color = textColor;
if (chart.options.plugins.legend) {
chart.options.plugins.legend.labels.color = textColor;
}
const gridColor = document.body.classList.contains('light-mode') ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
chart.options.scales.x.grid.color = gridColor;
chart.options.scales.y.grid.color = gridColor;
}

// Initialize h3 color based on current mode on load
window.addEventListener('load', () => {
document.documentElement.style.setProperty('--h3-color', document.body.classList.contains('light-mode') ? '#000000' : '#ffffff');
});
</script>

</body>
</html>



